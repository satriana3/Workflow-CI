name: Workflow CI - MLProject

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ml-ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: "3.12.7"

    - name: Install Python dependencies (pip)
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel
        pip install mlflow==2.19.0 scikit-learn pandas numpy

    - name: Ensure mlruns directory exists (and print tree)
      run: |
        mkdir -p $GITHUB_WORKSPACE/mlruns
        echo "Workspace: $GITHUB_WORKSPACE"
        ls -la
        pwd
        echo "---- MLProject tree ----"
        ls -R MLProject || true

    - name: Run MLflow Project (use local env manager)
      # Note: pass tracking_uri so artifacts are stored in workspace/mlruns
      run: |
        export MLFLOW_TRACKING_URI="file://$GITHUB_WORKSPACE/mlruns"
        echo "Using tracking uri: $MLFLOW_TRACKING_URI"
        mlflow run MLProject/ --env-manager=local \
          -P data_path=MLProject/studentsperformance_preprocessing/StudentsPerformance_preprocessing.csv \
          -P tracking_uri=$MLFLOW_TRACKING_URI \
          -P experiment_name=student_performance_experiment

    - name: Get MLflow EXP_ID and RUN_ID
      id: get_ids
      run: |
        set -e
        ls -la mlruns
        EXP_ID=$(ls mlruns | head -n 1)
        if [ -z "$EXP_ID" ]; then
          echo "No experiment folder found under mlruns/"
          exit 1
        fi
        RUN_ID=$(ls mlruns/"$EXP_ID" | grep -v meta.yaml | sort | tail -n 1)
        if [ -z "$RUN_ID" ]; then
          echo "No run found under mlruns/$EXP_ID"
          exit 1
        fi
        echo "EXP_ID=$EXP_ID" >> $GITHUB_ENV
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "Found EXP_ID=$EXP_ID RUN_ID=$RUN_ID"

    - name: Upload MLflow artifacts (mlruns folder)
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: mlruns/

    - name: Build Docker Image from MLflow model artifact
      env:
        DOCKER_IMAGE_NAME: "${{ secrets.DOCKER_USERNAME }}/student_performance_model:latest"
      run: |
        set -e
        echo "Listing mlruns folder:"
        ls -R mlruns || true
        MODEL_PATH="mlruns/${EXP_ID}/${RUN_ID}/artifacts/model"
        echo "MODEL_PATH=$MODEL_PATH"
        if [ ! -d "$MODEL_PATH" ]; then
          echo "Model artifact not found at $MODEL_PATH"
          exit 1
        fi
        # Build docker image (this requires Docker to be available on runner)
        mlflow models build-docker -m "$MODEL_PATH" -n "$DOCKER_IMAGE_NAME"

    - name: Log in to Docker Hub
      uses: docker/login-action@v4
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/student_performance_model:latest

    - name: Complete job
      run: echo "CI/CD workflow finished successfully."
